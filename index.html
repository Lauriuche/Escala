<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EscalaPro Cloud - Gestão Profissional</title>
    
    <!-- Meta tags para PWA e Mobile -->
    <meta name="theme-color" content="#f07556">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EscalaPro">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2693/2693507.png">

    <!-- Bibliotecas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --cell-width: 95px;
            --name-col-width: 200px;
            --role-col-width: 140px;
            --row-height: 48px;
            --sun-red: #f07556;
            --header-gray: #e2e8f0;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc;
            color: #0f172a;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain; /* Melhora o scroll no mobile */
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* --- Tabela --- */
        .table-container {
            overflow: auto;
            max-height: calc(100vh - 280px);
            border-radius: 20px;
            background: white;
            box-shadow: 0 4px 15px -3px rgba(0,0,0,0.05);
            border: 1px solid #cbd5e1;
            position: relative;
        }

        table { 
            border-collapse: separate; 
            border-spacing: 0; 
            width: max-content;
            background-color: white;
        }

        /* Colunas Fixas - Bloqueio total de cor (Opacas) */
        .sticky-col-1, .sticky-col-2 { 
            position: sticky; 
            z-index: 30; 
            background-color: white !important;
            opacity: 1;
        }
        
        .sticky-col-1 { 
            left: 0; 
            width: var(--name-col-width); 
            min-width: var(--name-col-width);
            box-shadow: 2px 0 0 0 #f1f5f9;
        }
        .sticky-col-2 { 
            left: var(--name-col-width); 
            width: var(--role-col-width); 
            min-width: var(--role-col-width); 
            box-shadow: 3px 0 0 0 #cbd5e1; 
        }
        
        /* Cabeçalhos Fixos */
        thead tr th { 
            position: sticky; 
            top: 0; 
            z-index: 50; 
            background: var(--header-gray) !important; 
            border-bottom: 2px solid #cbd5e1; 
            padding: 8px 14px; 
            color: #475569;
        }
        thead tr:nth-child(2) th { top: 42px; }

        .sticky-header-corner { 
            z-index: 60 !important; 
            background-color: var(--header-gray) !important; 
        }

        .day-col { 
            width: var(--cell-width); 
            min-width: var(--cell-width); 
            text-align: center; 
            border-right: 1px solid #e2e8f0; 
            border-bottom: 1px solid #e2e8f0; 
        }
        .weekday-label { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; }
        .day-label { font-size: 14px; font-weight: 800; color: #1e293b; }

        /* Domingo Unificado - Vermelho Forte */
        .sun-col { background-color: var(--sun-red) !important; color: white !important; } 
        .header-sun { background-color: var(--sun-red) !important; color: white !important; }
        
        .sun-col .time-text { color: white !important; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .sun-col .time-subtext { color: rgba(255, 255, 255, 0.85) !important; }
        .sun-col .empty-time { color: rgba(255, 255, 255, 0.4) !important; }

        /* Badges */
        .badge-dsr { background: #2563eb; color: white; font-size: 11px; font-weight: 900; padding: 4px 4px; width: 85%; border-radius: 6px; text-align: center; text-transform: uppercase; border: 1px solid #1d4ed8; }
        .badge-bh { background: #f97316; color: white; font-size: 11px; font-weight: 900; padding: 4px 4px; width: 85%; border-radius: 6px; text-align: center; text-transform: uppercase; border: 1px solid #ea580c; }
        .badge-vacation { background: #10b981; color: white; font-size: 11px; font-weight: 900; padding: 6px 4px; width: 85%; border-radius: 8px; text-align: center; text-transform: uppercase; border: 1px solid #059669; }

        .sun-col .badge-dsr, .sun-col .badge-bh, .sun-col .badge-vacation {
            border: 1.5px solid white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .cell-interactive {
            cursor: pointer;
            height: var(--row-height);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
            z-index: 10;
        }

        /* Alerta 6x1 */
        .cell-violation { background-color: #fef08a !important; border: 2px solid #eab308 !important; }
        .cell-violation-sun {
            background-color: var(--sun-red) !important;
            border: 2.5px solid #fef08a !important;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.15);
        }

        .time-text { font-size: 13px; font-weight: 800; color: #0f172a; letter-spacing: -0.02em; line-height: 1; }
        .time-subtext { font-size: 9px; font-weight: 600; color: #64748b; }

        /* Input Sequencial */
        .time-input-sequence {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #ffffff;
            padding: 4px;
            border-radius: 20px;
            border: 2px solid #e2e8f0;
        }
        .input-divider { width: 1px; height: 24px; background-color: #e2e8f0; }
        .seq-input { background: transparent; border: none; font-weight: 800; font-size: 18px; color: #1e293b; text-align: center; outline: none; width: 100px; padding: 8px 0; cursor: pointer; }
        .seq-input-small { width: 60px; font-size: 14px; color: #94a3b8; }
        .seq-label-tiny { font-size: 9px; font-weight: 800; color: #94a3b8; text-transform: uppercase; text-align: center; margin-bottom: 4px; }

        .modal-active { display: flex !important; animation: modalIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes modalIn { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .mode-button { flex: 1; padding: 12px 4px; border-radius: 12px; font-weight: 800; font-size: 10px; text-transform: uppercase; transition: 0.2s; cursor: pointer; text-align: center; color: #64748b; }
        .active-work { background-color: white; color: #2563eb; box-shadow: 0 4px 12px -2px rgba(37, 99, 235, 0.15); border: 1px solid rgba(37, 99, 235, 0.1); }
        .active-dsr { background-color: #2563eb; color: white; box-shadow: 0 4px 12px -2px rgba(37, 99, 235, 0.3); }
        .active-bh { background-color: #f97316; color: white; box-shadow: 0 4px 12px -2px rgba(249, 115, 22, 0.3); }
        .active-vacation { background-color: #10b981; color: white; box-shadow: 0 4px 12px -2px rgba(16, 185, 129, 0.3); }

        .nav-active { color: #2563eb !important; background-color: white !important; box-shadow: 0 4px 12px -2px rgba(0,0,0,0.05); }
        .emp-name-clickable { cursor: pointer; transition: color 0.2s; font-weight: 800; text-transform: uppercase; }
        .emp-name-clickable:hover { color: #2563eb; text-decoration: underline; }
        
        .toolbar-pill { background-color: #f1f5f9; padding: 4px; border-radius: 14px; display: flex; align-items: center; gap: 2px; border: 1px solid #e2e8f0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="antialiased">

    <!-- INTERFACE PRINCIPAL -->
    <div id="view-main" class="flex flex-col min-h-screen">
        <header class="bg-white border-b border-slate-200 px-6 py-4 flex flex-wrap justify-between items-center sticky top-0 z-50">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-2.5 rounded-xl shadow-lg rotate-3">
                    <i data-lucide="cloud" class="text-white w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="font-black text-xl text-slate-900 tracking-tighter leading-none uppercase text-blue-600">EscalaPro</h1>
                    <p id="connection-status" class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Ligar Cloud...</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex bg-slate-50 p-1 rounded-xl border border-slate-200">
                    <select id="monthSelect" onchange="initCalendar()" class="bg-transparent font-bold text-[11px] px-2 outline-none text-slate-700"></select>
                    <select id="yearSelect" onchange="initCalendar()" class="bg-transparent font-bold text-[11px] px-2 outline-none text-slate-700 border-l border-slate-200"></select>
                </div>
            </div>
        </header>

        <section class="bg-slate-50/50 px-6 py-3 border-b border-slate-200 flex flex-wrap items-center gap-4">
            <div class="toolbar-pill">
                <button onclick="switchPanel('scale')" id="nav-scale" class="flex items-center gap-2 px-5 py-2 rounded-lg text-[11px] font-black uppercase transition-all nav-active">
                    <i data-lucide="calendar" class="w-3.5 h-3.5"></i> Escala
                </button>
                <button onclick="switchPanel('admin')" id="nav-admin" class="flex items-center gap-2 px-5 py-2 rounded-lg text-[11px] font-black uppercase transition-all text-slate-500 hover:text-blue-600">
                    <i data-lucide="users" class="w-3.5 h-3.5"></i> Admin
                </button>
            </div>

            <div id="actions-scale" class="flex items-center gap-2">
                <button onclick="handleClearMonth()" class="flex items-center gap-2 bg-white border border-red-200 text-red-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-sm hover:bg-red-50 transition-all active:scale-95">
                    <i data-lucide="eraser" class="w-3.5 h-3.5"></i> Limpar Mês
                </button>
            </div>

            <div id="actions-admin" class="hidden flex items-center gap-2">
                <button onclick="openAddEmployeeModal()" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-md hover:bg-blue-700 transition-all active:scale-95">
                    <i data-lucide="user-plus" class="w-3.5 h-3.5"></i> Novo Funcionário
                </button>
            </div>
        </section>

        <main id="panel-scale" class="p-4 md:p-6 space-y-4">
            <div id="capture-container" class="table-container no-scrollbar">
                <table id="mainTable">
                    <thead>
                        <tr id="header-row-weekdays">
                            <th class="sticky-col-1 sticky-header-corner text-left px-4 text-[10px] font-black text-blue-600 uppercase tracking-tighter">Equipa Cloud</th>
                            <th class="sticky-col-2 sticky-header-corner"></th>
                        </tr>
                        <tr id="header-row-numbers">
                            <th class="sticky-col-1 sticky-header-corner text-[9px] font-black text-slate-400 text-left px-4 uppercase">Funcionário</th>
                            <th class="sticky-col-2 sticky-header-corner text-[9px] font-black text-slate-400 text-left px-4 uppercase">Cargo</th>
                        </tr>
                    </thead>
                    <tbody id="scaleBody"></tbody>
                </table>
            </div>

            <div class="flex justify-between items-center px-2">
                <div class="flex items-center gap-3 text-[9px] font-bold text-slate-400 uppercase">
                    <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 bg-[#f07556] rounded-sm"></span> DOMINGO</span>
                    <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 bg-yellow-400 rounded-sm border border-yellow-600"></span> ERRO 6X1</span>
                    <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 bg-blue-600 rounded-sm"></span> DSR</span>
                    <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 bg-orange-400 rounded-sm"></span> BH</span>
                    <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 bg-emerald-500 rounded-sm"></span> FÉRIAS</span>
                </div>
                <button onclick="exportAndShare()" class="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-full font-black text-[10px] uppercase tracking-widest hover:bg-green-700 transition-all active:scale-95 shadow-lg">
                    <i data-lucide="share-2" class="w-3.5 h-3.5"></i> Exportar JPG
                </button>
            </div>
        </main>

        <main id="panel-admin" class="hidden p-4 md:p-6 animate-in slide-in-from-bottom-4 duration-300">
            <div id="employeeList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </main>
    </div>

    <!-- MODAIS -->

    <div id="shiftModal" class="fixed inset-0 z-[100] hidden bg-slate-900/70 backdrop-blur-md items-center justify-center p-4">
        <div class="bg-white rounded-[48px] w-full max-w-sm shadow-2xl p-10 space-y-8 animate-in zoom-in duration-200">
            <div class="flex justify-between items-start">
                <div><h3 id="modalEmpName" class="text-2xl font-black text-slate-900 tracking-tighter leading-none uppercase"></h3><p id="modalDateLabel" class="text-blue-600 font-bold text-[11px] uppercase mt-2"></p></div>
                <button onclick="closeModal('shiftModal')" class="p-3 bg-slate-100 rounded-full text-slate-500 hover:bg-red-50"><i data-lucide="x"></i></button>
            </div>
            
            <div class="space-y-8">
                <div id="timeInputArea" class="space-y-2">
                    <div class="flex justify-around px-2">
                        <span class="seq-label-tiny">Entrada</span>
                        <span class="seq-label-tiny">Almoço</span>
                        <span class="seq-label-tiny">Saída</span>
                    </div>
                    <div class="time-input-sequence">
                        <input type="time" id="field-in" oninput="calculateAutoOut()" class="seq-input">
                        <div class="input-divider"></div>
                        <input type="number" id="field-lunch" step="0.5" value="2" oninput="calculateAutoOut()" class="seq-input seq-input-small">
                        <div class="input-divider"></div>
                        <input type="time" id="field-out" class="seq-input">
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Tipo de Registo</label>
                    <div class="flex bg-slate-100 p-1.5 rounded-2xl border border-slate-200 gap-1">
                        <button onclick="setEditMode('TRABALHO')" id="btn-mode-work" class="mode-button">TRABALHO</button>
                        <button onclick="setEditMode('DSR')" id="btn-mode-dsr" class="mode-button">DSR</button>
                        <button onclick="setEditMode('BH')" id="btn-mode-bh" class="mode-button">BH</button>
                        <button onclick="setEditMode('FERIAS')" id="btn-mode-vacation" class="mode-button">FÉRIAS</button>
                    </div>
                </div>

                <div class="p-6 bg-slate-50 rounded-[32px] border border-slate-100 space-y-4">
                    <label class="flex items-center gap-4 cursor-pointer group"><input type="checkbox" id="field-repeat" class="w-6 h-6 rounded-lg text-blue-600 border-slate-300 transition-all"><span class="text-xs font-bold uppercase text-slate-600">Replicar horários</span></label>
                    <label id="label-propagate" class="hidden flex items-center gap-4 cursor-pointer group"><input type="checkbox" id="field-propagate" class="w-6 h-6 rounded-lg text-green-600 border-slate-300 transition-all"><span class="text-xs font-bold uppercase text-green-700">Projetar Ciclo 6x1</span></label>
                </div>

                <div class="flex gap-3">
                    <button onclick="handleDeleteShiftRecord()" class="px-6 bg-red-50 text-red-500 rounded-[24px] border border-red-100 hover:bg-red-100 transition-all"><i data-lucide="trash-2" class="w-6 h-6"></i></button>
                    <button onclick="saveShift()" class="flex-1 bg-slate-900 text-white font-black py-6 rounded-[28px] shadow-2xl active:scale-95 text-sm uppercase tracking-widest uppercase">Sincronizar Cloud</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Funcionário -->
    <div id="employeeModal" class="fixed inset-0 z-[100] hidden bg-slate-900/60 backdrop-blur-md items-center justify-center p-4">
        <div class="bg-white rounded-[48px] w-full max-w-md p-12 shadow-2xl space-y-8 animate-in zoom-in duration-300">
            <h3 id="employeeModalTitle" class="text-2xl font-black text-slate-900 text-center uppercase tracking-tighter">Dados do Membro</h3>
            <div class="space-y-4">
                <input type="text" id="new-emp-name" placeholder="NOME COMPLETO" class="w-full p-5 bg-slate-50 border-2 border-transparent rounded-[24px] font-bold outline-none focus:border-blue-500 uppercase">
                <input type="text" id="new-emp-role" placeholder="CARGO / POSTO" class="w-full p-5 bg-slate-50 border-2 border-transparent rounded-[24px] font-bold outline-none focus:border-blue-500 uppercase">
            </div>
            <div class="flex gap-4 pt-4">
                <button onclick="closeModal('employeeModal')" class="flex-1 font-bold text-slate-400">Cancelar</button>
                <button onclick="saveEmployee()" class="flex-[2] bg-blue-600 text-white font-black py-5 rounded-[24px] shadow-xl hover:bg-blue-700 transition-all uppercase text-sm">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmação -->
    <div id="confirmModal" class="fixed inset-0 z-[600] hidden bg-slate-950/80 backdrop-blur-sm items-center justify-center p-4">
        <div class="bg-white rounded-[40px] w-full max-w-sm p-10 shadow-2xl text-center space-y-8 animate-in zoom-in duration-200">
            <div class="bg-red-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto text-red-500 mb-4">
                <i data-lucide="alert-triangle" class="w-10 h-10"></i>
            </div>
            <div>
                <h3 id="confirmModalTitle" class="text-xl font-black text-slate-900 leading-tight uppercase">Confirmar</h3>
                <p id="confirmModalText" class="text-slate-500 text-sm mt-3 font-medium uppercase">Ação irreversível.</p>
            </div>
            <div class="flex gap-3 pt-4">
                <button onclick="closeModal('confirmModal')" class="flex-1 font-bold text-slate-400 py-4 cursor-pointer">Voltar</button>
                <button id="confirmModalBtn" class="flex-[2] bg-red-500 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all cursor-pointer uppercase">Eliminar</button>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 z-[700] hidden bg-slate-950/90 backdrop-blur-md flex flex-col items-center justify-center text-white text-center p-6">
        <div class="w-12 h-12 border-4 border-white/10 border-t-white rounded-full animate-spin mb-4"></div>
        <p id="loadingText" class="font-black text-[10px] uppercase tracking-[0.2em] animate-pulse">Sincronizando...</p>
    </div>

    <div id="toastContainer" class="fixed bottom-10 right-10 z-[800] space-y-4 pointer-events-none"></div>

    <script>
        const SUPABASE_URL = 'https://cjcnqvdrztnhepxtlgju.supabase.co'; 
        const SUPABASE_ANON_KEY = 'sb_publishable_3amBXdvUsQWYvf2qP4Ljbg_d3GDqglr';
        var sbClient;

        const RULES = { WORK_NORMAL: 440, MAX_CONSECUTIVE: 6 };
        const WEEKDAYS = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SÁB'];
        
        let employees = [], shifts = {}; 
        let currentMode = 'TRABALHO', editingEmployeeId = null, editingContext = null;
        let deleteTargetId = null;
        let deleteTargetType = null;

        // --- LÓGICA DE INSTALAÇÃO PWA ---
        function setupPWA() {
            const manifest = {
                name: "EscalaPro Cloud",
                short_name: "EscalaPro",
                start_url: ".",
                display: "standalone",
                background_color: "#ffffff",
                theme_color: "#f07556",
                icons: [{
                    src: "https://cdn-icons-png.flaticon.com/512/2693/2693507.png",
                    sizes: "512x512",
                    type: "image/png"
                }]
            };
            const stringManifest = JSON.stringify(manifest);
            const blob = new Blob([stringManifest], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);

            if ('serviceWorker' in navigator) {
                const swCode = `
                    self.addEventListener('install', (e) => {
                        self.skipWaiting();
                    });
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(fetch(e.request));
                    });
                `;
                const swBlob = new Blob([swCode], {type: 'application/javascript'});
                const swURL = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swURL).catch(() => {});
            }
        }

        window.onload = async () => {
            setupPWA();
            setupSelectors();
            await initSupabase();
            lucide.createIcons();
        };

        async function initSupabase() {
            const lib = (typeof supabase !== 'undefined' && supabase.createClient) ? supabase : (typeof supabasejs !== 'undefined' ? supabasejs : null);
            if (!lib) { setTimeout(initSupabase, 200); return; }
            try {
                sbClient = lib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                document.getElementById('connection-status').innerText = 'Online';
                document.getElementById('connection-status').classList.replace('text-slate-400', 'text-green-500');
                await loadAllData();
                initCalendar();
            } catch(e) { showToast("Erro na Cloud."); }
        }

        function switchPanel(panelId) {
            const pScale = document.getElementById('panel-scale'), pAdmin = document.getElementById('panel-admin');
            const nScale = document.getElementById('nav-scale'), nAdmin = document.getElementById('nav-admin');
            const aScale = document.getElementById('actions-scale'), aAdmin = document.getElementById('actions-admin');
            pScale.classList.toggle('hidden', panelId !== 'scale');
            pAdmin.classList.toggle('hidden', panelId !== 'admin');
            aScale.classList.toggle('hidden', panelId !== 'scale');
            aAdmin.classList.toggle('hidden', panelId !== 'admin');
            nScale.className = panelId === 'scale' ? 'flex items-center gap-2 px-5 py-2 rounded-lg text-[11px] font-black uppercase transition-all nav-active' : 'flex items-center gap-2 px-5 py-2 rounded-lg text-[11px] font-black uppercase transition-all text-slate-500';
            nAdmin.className = panelId === 'admin' ? 'flex items-center gap-2 px-5 py-2 rounded-lg text-[11px] font-black uppercase transition-all nav-active' : 'flex items-center gap-2 px-5 py-2 rounded-lg text-[11px] font-black uppercase transition-all text-slate-500';
            if(panelId === 'admin') renderEmployees(); else renderScale();
            lucide.createIcons();
        }

        async function loadAllData() {
            if(!sbClient) return;
            try {
                const { data: empData } = await sbClient.from('employees').select('*').order('name');
                employees = empData || [];
                const { data: shiftData } = await sbClient.from('shifts').select('*');
                shifts = {};
                shiftData?.forEach(item => {
                    if(!shifts[item.employee_id]) shifts[item.employee_id] = {};
                    shifts[item.employee_id][item.day_key] = item.shift_data;
                });
                renderEmployees(); renderScale();
            } catch (err) { console.error(err); }
        }

        async function saveEmployee() {
            const name = document.getElementById('new-emp-name').value.trim(), role = document.getElementById('new-emp-role').value.trim();
            if (!name) return showToast("Nome é obrigatório!");
            setLoading(true);
            try {
                const payload = { name, role };
                if (editingEmployeeId) await sbClient.from('employees').update(payload).eq('id', editingEmployeeId);
                else await sbClient.from('employees').insert([payload]);
                closeModal('employeeModal'); await loadAllData(); showToast("Guardado!");
            } catch (err) { showToast("Falha."); } finally { setLoading(false); }
        }

        function removeEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            deleteTargetId = id; deleteTargetType = 'employee';
            document.getElementById('confirmModalTitle').innerText = "Eliminar";
            document.getElementById('confirmModalText').innerText = `Eliminar ${emp.name.toUpperCase()}?`;
            document.getElementById('confirmModalBtn').onclick = executeDelete;
            openModal('confirmModal');
        }

        function handleDeleteShiftRecord() {
            deleteTargetType = 'shift';
            document.getElementById('confirmModalTitle').innerText = "Limpar";
            document.getElementById('confirmModalText').innerText = "Deseja limpar todos os registos deste dia?";
            document.getElementById('confirmModalBtn').onclick = executeDelete;
            openModal('confirmModal');
        }

        function handleClearMonth() {
            deleteTargetType = 'clear_month';
            document.getElementById('confirmModalTitle').innerText = "Limpar Mês";
            document.getElementById('confirmModalText').innerText = "Apagar tudo deste mês?";
            document.getElementById('confirmModalBtn').onclick = executeDelete;
            openModal('confirmModal');
        }

        async function executeDelete() {
            closeModal('confirmModal'); setLoading(true, "A apagar...");
            try {
                if (deleteTargetType === 'employee') {
                    await sbClient.from('shifts').delete().eq('employee_id', deleteTargetId);
                    await sbClient.from('employees').delete().eq('id', deleteTargetId);
                } else if (deleteTargetType === 'shift') {
                    const key = `${editingContext.year}-${editingContext.month}-${editingContext.day}`;
                    await sbClient.from('shifts').delete().match({ employee_id: editingContext.empId, day_key: key });
                    closeModal('shiftModal');
                } else if (deleteTargetType === 'clear_month') {
                    const pattern = `${document.getElementById('yearSelect').value}-${document.getElementById('monthSelect').value}-`;
                    await sbClient.from('shifts').delete().like('day_key', `${pattern}%`);
                }
                await loadAllData(); showToast("Sucesso!");
            } catch (err) { console.error(err); showToast("Erro."); }
            finally { setLoading(false); deleteTargetId = null; deleteTargetType = null; }
        }

        async function saveShift() {
            const { empId, day, month, year } = editingContext;
            const repeat = document.getElementById('field-repeat').checked, propagate = document.getElementById('field-propagate').checked;
            const isFolga = (currentMode !== 'TRABALHO');
            const shiftData = { in: document.getElementById('field-in').value, out: document.getElementById('field-out').value, lunch: document.getElementById('field-lunch').value, isFolga, tipoFolga: isFolga ? currentMode : null };
            const upserts = [{ employee_id: empId, day_key: `${year}-${month}-${day}`, shift_data: shiftData }];
            if (repeat) {
                const dMax = new Date(year, parseInt(month) + 1, 0).getDate();
                for (let d = day + 1; d <= dMax; d++) {
                    const targetKey = `${year}-${month}-${d}`;
                    if (shifts[empId]?.[targetKey]?.isFolga) continue; 
                    upserts.push({ employee_id: empId, day_key: targetKey, shift_data: shiftData });
                }
            }
            if (currentMode === 'DSR' && propagate) {
                const dMax = new Date(year, parseInt(month) + 1, 0).getDate();
                for (let d = day + 7; d <= dMax; d += 7) upserts.push({ employee_id: empId, day_key: `${year}-${month}-${d}`, shift_data: { ...shiftData, isFolga: true, tipoFolga: 'DSR' } });
            }
            setLoading(true);
            const { error } = await sbClient.from('shifts').upsert(upserts, { onConflict: 'employee_id, day_key' });
            setLoading(false);
            if(!error) { await loadAllData(); closeModal('shiftModal'); showToast("Sincronizado!"); }
        }

        function initCalendar() {
            const month = parseInt(document.getElementById('monthSelect').value), year = parseInt(document.getElementById('yearSelect').value), dMax = new Date(year, month + 1, 0).getDate();
            const rowW = document.getElementById('header-row-weekdays'), rowN = document.getElementById('header-row-numbers');
            while (rowW.cells.length > 2) rowW.deleteCell(2);
            while (rowN.cells.length > 2) rowN.deleteCell(2);
            for (let d = 1; d <= dMax; d++) {
                const date = new Date(year, month, d), isSun = date.getDay() === 0, isToday = d === new Date().getDate() && month === new Date().getMonth();
                const thW = document.createElement('th'); thW.className = `day-col weekday-label ${isSun ? 'header-sun' : ''}`; thW.innerText = WEEKDAYS[date.getDay()]; rowW.appendChild(thW);
                const thN = document.createElement('th'); thN.className = `day-col day-label ${isSun ? 'header-sun' : ''} ${isToday ? 'bg-blue-600 text-white rounded-t-xl' : ''}`; thN.innerText = String(d).padStart(2, '0'); rowN.appendChild(thN);
            }
            renderScale();
        }

        function renderScale() {
            const body = document.getElementById('scaleBody'), monthSelect = document.getElementById('monthSelect').value, yearSelect = document.getElementById('yearSelect').value;
            const daysInMonthCalculated = new Date(yearSelect, parseInt(monthSelect) + 1, 0).getDate();
            if (employees.length === 0) { body.innerHTML = `<tr><td colspan="40" class="p-12 text-center text-slate-300 font-bold italic uppercase text-[10px]">Vazio</td></tr>`; return; }
            body.innerHTML = employees.map(emp => {
                const violations = getEmployeeViolationDays(emp.id, monthSelect, yearSelect, daysInMonthCalculated);
                let cells = '';
                for (let d = 1; d <= daysInMonthCalculated; d++) {
                    const key = `${yearSelect}-${monthSelect}-${d}`, shift = shifts[emp.id]?.[key], isSun = new Date(yearSelect, parseInt(monthSelect), d).getDay() === 0;
                    let content = '<span class="empty-time text-[10px] font-bold tracking-tighter opacity-30">--:--</span>';
                    let bg = isSun ? "sun-col" : "";
                    if (violations.has(d) && shift && !shift.isFolga) {
                        bg += isSun ? " cell-violation-sun" : " cell-violation";
                    }
                    if (shift) {
                        if (shift.isFolga) {
                            if (shift.tipoFolga === 'FERIAS') content = `<div class="badge-vacation">FÉRIAS</div>`;
                            else content = (shift.tipoFolga === 'DSR') ? `<div class="badge-dsr">DSR</div>` : `<div class="badge-bh">BH</div>`; 
                        } else { 
                            content = `<div class="time-text">${shift.in}</div><div class="time-subtext">${shift.out}</div>`; 
                        }
                    }
                    cells += `<td class="day-col ${bg}"><div class="cell-interactive" onclick="openShiftModal('${emp.id}', ${d})">${content}</div></td>`;
                }
                return `<tr>
                    <td class="sticky-col-1 p-2"><span class="emp-name-clickable text-[13px] truncate-cell leading-none uppercase" onclick="openEditEmployeeModal('${emp.id}')">${emp.name}</span></td>
                    <td class="sticky-col-2 p-2"><span class="text-[10px] font-bold text-slate-400 uppercase truncate-cell">${emp.role || '---'}</span></td>
                    ${cells}
                </tr>`;
            }).join('');
            lucide.createIcons();
        }

        function calculateAutoOut() {
            const v = document.getElementById('field-in').value, l = parseFloat(document.getElementById('field-lunch').value || 0);
            if(v) { 
                const [h, m] = v.split(':').map(Number), t = (h*60+m+440+(l*60))%1440; 
                document.getElementById('field-out').value = `${String(Math.floor(t/60)).padStart(2, '0')}:${String(t%60).padStart(2, '0')}`; 
            }
        }

        function setEditMode(m) {
            currentMode = m;
            const bW = document.getElementById('btn-mode-work'), bD = document.getElementById('btn-mode-dsr');
            const bB = document.getElementById('btn-mode-bh'), bF = document.getElementById('btn-mode-vacation');
            const inputArea = document.getElementById('timeInputArea');
            const labelPropagate = document.getElementById('label-propagate');
            [bW, bD, bB, bF].forEach(b => b.className = 'mode-button');
            labelPropagate.classList.toggle('hidden', m !== 'DSR');
            if(m === 'TRABALHO') { bW.classList.add('active-work'); inputArea.classList.remove('hidden'); calculateAutoOut(); }
            else {
                if(m === 'DSR') bD.classList.add('active-dsr');
                else if(m === 'BH') bB.classList.add('active-bh');
                else bF.classList.add('active-vacation');
                inputArea.classList.add('hidden');
            }
        }

        function getEmployeeViolationDays(empId, month, year, dMax) {
            let violatingDays = new Set(), streak = [];
            for (let d = 1; d <= dMax; d++) {
                const shift = shifts[empId]?.[`${year}-${month}-${d}`];
                const isBreak = shift && shift.isFolga && (shift.tipoFolga === 'DSR' || shift.tipoFolga === 'FERIAS');
                if (isBreak) { if (streak.length > 6) streak.forEach(day => violatingDays.add(day)); streak = []; }
                else streak.push(d);
            }
            if (streak.length > 6) streak.forEach(day => violatingDays.add(day));
            return violatingDays;
        }

        function openAddEmployeeModal() { editingEmployeeId = null; document.getElementById('employeeModalTitle').innerText = "Novo Membro"; document.getElementById('new-emp-name').value = ""; document.getElementById('new-emp-role').value = ""; openModal('employeeModal'); }
        function openEditEmployeeModal(id) { const emp = employees.find(e => String(e.id) === String(id)); if (!emp) return; if(document.getElementById('panel-admin').classList.contains('hidden')) switchPanel('admin'); editingEmployeeId = id; document.getElementById('employeeModalTitle').innerText = "Editar Membro"; document.getElementById('new-emp-name').value = emp.name.toUpperCase(); document.getElementById('new-emp-role').value = (emp.role || "").toUpperCase(); openModal('employeeModal'); }
        function openShiftModal(empId, d) { 
            const key = `${document.getElementById('yearSelect').value}-${document.getElementById('monthSelect').value}-${d}`, shift = shifts[empId]?.[key] || { in: '08:00', out: '17:20', lunch: 2, isFolga: false }; 
            editingContext = { empId, day: d, month: document.getElementById('monthSelect').value, year: document.getElementById('yearSelect').value }; 
            document.getElementById('modalEmpName').innerText = employees.find(e => e.id === empId).name.toUpperCase(); 
            document.getElementById('modalDateLabel').innerText = `DIA ${d} • TURNO`; 
            document.getElementById('field-in').value = shift.in; document.getElementById('field-out').value = shift.out; document.getElementById('field-lunch').value = shift.lunch; 
            document.getElementById('field-repeat').checked = false; document.getElementById('field-propagate').checked = false; 
            setEditMode(shift.isFolga ? (shift.tipoFolga || 'DSR') : 'TRABALHO'); 
            openModal('shiftModal'); 
        }
        
        function renderEmployees() { const list = document.getElementById('employeeList'); list.innerHTML = employees.map(emp => `
            <div class="bg-white p-4 rounded-3xl border flex justify-between items-center group hover:border-blue-600 shadow-sm">
                <div><h4 class="font-extrabold text-slate-900 text-sm leading-tight uppercase">${emp.name}</h4><p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">${emp.role || 'Geral'}</p></div>
                <div class="flex gap-1">
                    <button onclick="openEditEmployeeModal('${emp.id}')" class="p-3 text-blue-600 hover:bg-blue-50 rounded-xl transition-all cursor-pointer"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="removeEmployee('${emp.id}')" class="p-3 text-red-400 hover:bg-red-50 rounded-xl transition-all cursor-pointer"><i data-lucide="user-minus" class="w-4 h-4"></i></button>
                </div>
            </div>`).join(''); lucide.createIcons(); }
        function setupSelectors() { const mS = document.getElementById('monthSelect'), yS = document.getElementById('yearSelect'), n = new Date(); ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"].forEach((m, i) => mS.innerHTML += `<option value="${i}" ${i === n.getMonth() ? 'selected' : ''}>${m}</option>`); for(let y = 2025; y <= 2026; y++) yS.innerHTML += `<option value="${y}" ${y === n.getFullYear() ? 'selected' : ''}>${y}</option>`; }
        function openModal(id) { document.getElementById(id).classList.add('modal-active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('modal-active'); }
        function setLoading(s, t = "Sincronizando...") { document.getElementById('loadingOverlay').classList.toggle('hidden', !s); document.getElementById('loadingText').innerText = t; }
        function showToast(m) { const c = document.getElementById('toastContainer'), t = document.createElement('div'); t.className = "bg-slate-900 text-white px-6 py-3 rounded-2xl text-[10px] font-black shadow-2xl animate-bounce"; t.innerText = m.toUpperCase(); c.appendChild(t); setTimeout(() => t.remove(), 4000); }

        async function exportAndShare() {
            const area = document.getElementById('capture-container'), mainBody = document.body; mainBody.classList.add('exporting'); setLoading(true, "A gerar imagem...");
            try {
                const canvas = await html2canvas(area, { scale: 2.5, useCORS: true, backgroundColor: "#ffffff", width: area.scrollWidth, height: area.scrollHeight, onclone: (doc) => {
                    const el = doc.querySelector('.table-container'); el.style.maxHeight = 'none'; el.style.width = area.scrollWidth + 'px';
                    doc.querySelectorAll('.sticky-col-1, .sticky-col-2, thead tr th').forEach(s => s.style.position = 'static');
                }});
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `Escala.jpg`, { type: 'image/jpeg' });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) await navigator.share({ files: [file], title: `Escala Mensal` });
                    else { const a = document.createElement('a'); a.download = `Escala.jpg`; a.href = URL.createObjectURL(blob); a.click(); }
                }, 'image/jpeg', 0.95);
            } catch (err) { console.error(err); } finally { setLoading(false); mainBody.classList.remove('exporting'); }
        }
    </script>
</body>
</html>
