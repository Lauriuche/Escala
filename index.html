<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EscalaPro - Gestão Mensal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .table-container {
            overflow-x: auto;
            max-height: 75vh;
            border-radius: 12px;
        }
        
        table { border-spacing: 0; border-collapse: separate; table-layout: fixed; }
        
        /* Coluna fixa com mais destaque */
        .sticky-col {
            position: sticky;
            left: 0;
            background: white;
            z-index: 30;
            border-right: 3px solid #e2e8f0;
            min-width: 180px;
            width: 180px;
        }

        .header-sticky {
            position: sticky;
            top: 0;
            z-index: 40;
        }

        /* Aumentado o espaçamento entre os dias */
        .day-cell {
            min-width: 70px; /* Largura aumentada para dar espaço */
            width: 70px;
            text-align: center;
            border-right: 1px solid #f1f5f9;
            transition: all 0.2s;
        }

        .day-cell:hover {
            background-color: #f8fafc;
        }

        .weekend { background-color: #f1f5f9; color: #64748b; }
        .today { background-color: #dbeafe; color: #1e40af; font-weight: 800; border-bottom: 3px solid #2563eb; }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }

        /* Estilo para o conteúdo da célula */
        .cell-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 55px; /* Altura aumentada para melhor espaçamento vertical */
            gap: 2px;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 pb-20 md:pb-0">

    <nav class="sticky top-0 z-[50] glass-morphism px-4 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2">
            <div class="bg-blue-600 p-2 rounded-xl shadow-lg">
                <i data-lucide="calendar" class="text-white w-5 h-5"></i>
            </div>
            <h1 class="font-bold text-xl tracking-tight">Escala<span class="text-blue-600">Pro</span></h1>
        </div>
        <div class="flex items-center gap-4 bg-white border border-slate-200 px-4 py-2 rounded-2xl shadow-sm">
            <div class="flex items-center gap-2">
                <i data-lucide="calendar-days" class="w-4 h-4 text-slate-400"></i>
                <select id="monthSelect" onchange="initCalendar()" class="bg-transparent font-bold text-sm outline-none cursor-pointer text-slate-700">
                    <!-- Preenchido via JS -->
                </select>
            </div>
            <div class="w-px h-4 bg-slate-200"></div>
            <select id="yearSelect" onchange="initCalendar()" class="bg-transparent font-bold text-sm outline-none cursor-pointer text-slate-700">
                <!-- Preenchido via JS -->
            </select>
        </div>
    </nav>

    <main class="max-w-[100vw] overflow-hidden p-4 md:p-8">
        
        <!-- Tabs -->
        <div class="flex bg-slate-200/50 p-1.5 rounded-2xl max-w-[280px] mx-auto shadow-inner mb-8">
            <button onclick="switchTab('escada')" id="tab-escada" class="flex-1 py-2 px-4 rounded-xl font-bold text-xs transition-all bg-white shadow-sm text-blue-600">ESCALA</button>
            <button onclick="switchTab('funcionarios')" id="tab-funcionarios" class="flex-1 py-2 px-4 rounded-xl font-bold text-xs transition-all text-slate-500 hover:text-slate-900">EQUIPA</button>
        </div>

        <!-- Secção de Escala Mensal -->
        <section id="section-escada" class="space-y-6">
            <div class="bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden">
                <div class="table-container custom-scrollbar">
                    <table class="w-full">
                        <thead class="header-sticky">
                            <!-- Linha 1: Dias da Semana -->
                            <tr class="bg-slate-100 border-b border-slate-200 text-[10px] uppercase font-black text-slate-500">
                                <th class="p-4 sticky-col text-left bg-slate-100">FUNCIONÁRIO</th>
                                <th id="weekdayHeaders" class="contents"></th>
                            </tr>
                            <!-- Linha 2: Números dos Dias -->
                            <tr class="bg-white border-b border-slate-200 text-slate-700">
                                <th class="p-4 sticky-col text-left text-[10px] font-bold text-blue-600 bg-white">NOME / FUNÇÃO</th>
                                <th id="dayNumberHeaders" class="contents"></th>
                            </tr>
                        </thead>
                        <tbody id="scaleTableBody">
                            <!-- Inserido via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Legendas e Avisos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="flex items-center gap-2 text-[11px] font-bold text-slate-600 uppercase">
                        <span class="w-4 h-4 bg-green-100 border border-green-300 rounded-md"></span> Folga
                    </div>
                    <div class="flex items-center gap-2 text-[11px] font-bold text-slate-600 uppercase">
                        <span class="w-4 h-4 bg-red-100 border border-red-300 rounded-md"></span> Erro de Regras
                    </div>
                </div>
                <div class="text-[11px] text-slate-400 italic md:text-right">
                    Dica: Clique em qualquer quadrado para definir o horário ou marcar folga.
                </div>
            </div>
        </section>

        <!-- Secção de Equipa -->
        <section id="section-funcionarios" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-black text-slate-800 tracking-tight">Equipa Ativa</h2>
                <button onclick="openEmployeeModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-2xl flex items-center gap-2 font-bold transition-all shadow-lg active:scale-95">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Novo Membro
                </button>
            </div>
            <div id="employeeList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>
    </main>

    <!-- Modal Editar Turno -->
    <div id="shiftModal" class="fixed inset-0 z-[100] hidden bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white rounded-[32px] w-full max-w-sm shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
            <div class="p-8 space-y-8">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-2xl font-black text-slate-900" id="modalTitle">Turno</h3>
                        <p class="text-slate-400 font-medium" id="modalDayLabel"></p>
                    </div>
                    <button onclick="closeShiftModal()" class="bg-slate-100 p-2 rounded-full text-slate-400 hover:text-slate-900 transition-colors"><i data-lucide="x"></i></button>
                </div>
                
                <div class="space-y-6">
                    <label class="flex items-center gap-4 p-5 bg-slate-50 rounded-3xl border-2 border-transparent cursor-pointer transition-all hover:bg-green-50 has-[:checked]:border-green-500 has-[:checked]:bg-green-50 group">
                        <input type="checkbox" id="isFolga" onchange="toggleShiftInputs()" class="w-6 h-6 rounded-lg border-slate-300 text-green-600 focus:ring-green-500 transition-all">
                        <div>
                            <span class="block font-black text-slate-800 group-has-[:checked]:text-green-700">MARCAR FOLGA</span>
                            <span class="text-xs text-slate-500">O funcionário não trabalhará neste dia</span>
                        </div>
                    </label>

                    <div id="shiftInputs" class="space-y-4 transition-all duration-300">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Entrada</label>
                                <input type="time" id="shiftIn" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Saída</label>
                                <input type="time" id="shiftOut" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Almoço (Horas)</label>
                            <input type="number" id="shiftLunch" step="0.5" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        </div>
                    </div>

                    <button onclick="saveShift()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-[24px] shadow-xl shadow-blue-100 transition-all active:scale-95">
                        GUARDAR ALTERAÇÕES
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo Funcionário -->
    <div id="employeeModal" class="fixed inset-0 z-[100] hidden bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white rounded-[32px] w-full max-w-md p-8 space-y-6 shadow-2xl">
            <h3 class="text-2xl font-black text-slate-900">Novo Membro</h3>
            <div class="space-y-4">
                <input type="text" id="empName" placeholder="Nome Completo" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                <input type="text" id="empRole" placeholder="Cargo / Função" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500 font-medium">
            </div>
            <div class="flex gap-3">
                <button onclick="toggleModal('employeeModal', false)" class="flex-1 text-slate-400 font-bold">Cancelar</button>
                <button onclick="addEmployee()" class="flex-[2] bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg">Adicionar à Equipa</button>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] space-y-2 pointer-events-none"></div>

    <script>
        const RULES = { WORK_MIN: 440, MAX_OVERTIME: 120, MIN_REST: 660, MAX_DAYS: 6 };
        const WEEKDAYS = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SÁB'];
        
        let employees = JSON.parse(localStorage.getItem('ep_emp')) || [];
        let shifts = JSON.parse(localStorage.getItem('ep_shifts')) || {}; 
        let currentEditing = { empId: null, day: null };
        let currentDate = new Date();

        window.onload = () => {
            fillSelectors();
            initCalendar();
            renderAll();
        };

        function fillSelectors() {
            const mSel = document.getElementById('monthSelect');
            const ySel = document.getElementById('yearSelect');
            const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            
            months.forEach((m, i) => {
                mSel.innerHTML += `<option value="${i}" ${i === currentDate.getMonth() ? 'selected' : ''}>${m}</option>`;
            });

            for(let y = 2024; y <= 2026; y++) {
                ySel.innerHTML += `<option value="${y}" ${y === currentDate.getFullYear() ? 'selected' : ''}>${y}</option>`;
            }
        }

        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }

        function initCalendar() {
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            const daysCount = getDaysInMonth(month, year);
            
            const weekdayRow = document.getElementById('weekdayHeaders');
            const numberRow = document.getElementById('dayNumberHeaders');
            
            weekdayRow.innerHTML = '';
            numberRow.innerHTML = '';

            for(let d = 1; d <= daysCount; d++) {
                const date = new Date(year, month, d);
                const dayName = WEEKDAYS[date.getDay()];
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const isToday = d === new Date().getDate() && month === new Date().getMonth();

                weekdayRow.innerHTML += `<th class="day-cell p-3 ${isWeekend ? 'weekend' : ''}">${dayName}</th>`;
                numberRow.innerHTML += `<th class="day-cell p-2 border-l border-slate-100 ${isToday ? 'today' : ''}">${d}</th>`;
            }
            renderScale();
        }

        function renderAll() {
            renderEmployees();
            renderScale();
            lucide.createIcons();
        }

        function renderEmployees() {
            const list = document.getElementById('employeeList');
            if(employees.length === 0) {
                list.innerHTML = `<div class="col-span-full text-center py-20 bg-white rounded-[32px] border-2 border-dashed border-slate-200 text-slate-400 font-medium">Não existem membros registados.</div>`;
                return;
            }
            list.innerHTML = employees.map(emp => `
                <div class="bg-white p-6 rounded-[24px] border border-slate-200 shadow-sm flex justify-between items-center group hover:shadow-xl hover:border-blue-200 transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center text-white font-black text-xl shadow-lg">${emp.name.charAt(0)}</div>
                        <div>
                            <h4 class="font-black text-slate-800 tracking-tight">${emp.name}</h4>
                            <p class="text-[11px] text-slate-400 uppercase font-black tracking-widest">${emp.role}</p>
                        </div>
                    </div>
                    <button onclick="removeEmployee(${emp.id})" class="p-3 text-slate-200 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            `).join('');
        }

        function renderScale() {
            const body = document.getElementById('scaleTableBody');
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            const daysCount = getDaysInMonth(month, year);
            const storageKey = `${year}-${month}`;

            if(employees.length === 0) {
                body.innerHTML = `<tr><td colspan="${daysCount + 1}" class="p-20 text-center text-slate-300 font-black italic uppercase tracking-widest">Sem Equipa Ativa</td></tr>`;
                return;
            }

            body.innerHTML = employees.map(emp => {
                let cells = '';
                for(let d = 1; d <= daysCount; d++) {
                    const dateKey = `${storageKey}-d${d}`;
                    const shift = (shifts[emp.id] && shifts[emp.id][dateKey]) || null;
                    const violations = checkViolations(emp.id, d, month, year);
                    
                    let content = '<span class="opacity-0">.</span>';
                    let cellClass = "day-cell p-0 cursor-pointer border-l border-slate-100";
                    
                    if(shift) {
                        if(shift.isFolga) {
                            content = '<span class="text-[9px] font-black text-green-600 bg-green-100 px-2 py-1 rounded-md">FOLGA</span>';
                        } else {
                            const [hIn, mIn] = shift.in.split(':');
                            const [hOut, mOut] = shift.out.split(':');
                            content = `
                                <div class="font-black text-slate-800 text-xs">${hIn}:${mIn}</div>
                                <div class="text-[9px] font-bold text-slate-400">${hOut}:${mOut}</div>
                            `;
                        }
                    }

                    if(violations.length > 0) cellClass += " bg-red-50 border-b-2 border-red-400";

                    cells += `
                        <td onclick="openShiftModal(${emp.id}, ${d})" class="${cellClass}">
                            <div class="cell-content">
                                ${content}
                            </div>
                        </td>`;
                }
                return `
                    <tr class="group">
                        <td class="sticky-col p-4 bg-white z-10 shadow-[8px_0_15px_-5px_rgba(0,0,0,0.05)] border-b border-slate-100">
                            <div class="font-black text-slate-800 text-sm truncate">${emp.name}</div>
                            <div class="text-[10px] font-black text-blue-600 uppercase tracking-tighter opacity-60 truncate">${emp.role}</div>
                        </td>
                        ${cells}
                    </tr>
                `;
            }).join('');
            lucide.createIcons();
        }

        function checkViolations(empId, day, month, year) {
            const errors = [];
            const key = `${year}-${month}-d${day}`;
            const shift = shifts[empId]?.[key];
            if(!shift) return [];

            if(!shift.isFolga) {
                const workedMinutes = calcDiff(shift.in, shift.out) - (parseFloat(shift.lunch || 0) * 60);
                if(workedMinutes > (RULES.WORK_MIN + RULES.MAX_OVERTIME)) errors.push(`Carga excessiva`);
            }

            if(day > 1 && !shift.isFolga) {
                const prevShift = shifts[empId]?.[`${year}-${month}-d${day-1}`];
                if(prevShift && !prevShift.isFolga) {
                    const rest = (1440 - timeToMin(prevShift.out)) + timeToMin(shift.in);
                    if(rest < RULES.MIN_REST) errors.push(`Descanso curto`);
                }
            }
            return errors;
        }

        function openShiftModal(empId, day) {
            currentEditing = { empId, day };
            const month = document.getElementById('monthSelect').value;
            const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const year = document.getElementById('yearSelect').value;
            const key = `${year}-${month}-d${day}`;
            
            const emp = employees.find(e => e.id === empId);
            const shift = shifts[empId]?.[key] || { in: '08:00', out: '17:20', lunch: 2, isFolga: false };
            
            document.getElementById('modalTitle').innerText = emp.name;
            document.getElementById('modalDayLabel').innerText = `${day} de ${months[month]} de ${year}`;
            document.getElementById('shiftIn').value = shift.in;
            document.getElementById('shiftOut').value = shift.out;
            document.getElementById('shiftLunch').value = shift.lunch;
            document.getElementById('isFolga').checked = shift.isFolga;
            
            toggleShiftInputs();
            document.getElementById('shiftModal').classList.remove('hidden');
        }

        function toggleShiftInputs() {
            const isFolga = document.getElementById('isFolga').checked;
            const inputs = document.getElementById('shiftInputs');
            inputs.style.opacity = isFolga ? '0.2' : '1';
            inputs.style.pointerEvents = isFolga ? 'none' : 'auto';
            inputs.style.transform = isFolga ? 'scale(0.95)' : 'scale(1)';
        }

        function saveShift() {
            const { empId, day } = currentEditing;
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearSelect').value;
            const key = `${year}-${month}-d${day}`;
            
            if(!shifts[empId]) shifts[empId] = {};
            shifts[empId][key] = {
                in: document.getElementById('shiftIn').value,
                out: document.getElementById('shiftOut').value,
                lunch: document.getElementById('shiftLunch').value,
                isFolga: document.getElementById('isFolga').checked
            };

            localStorage.setItem('ep_shifts', JSON.stringify(shifts));
            renderScale();
            closeShiftModal();
            showToast("Alterações Gravadas");
        }

        function addEmployee() {
            const n = document.getElementById('empName').value;
            const r = document.getElementById('empRole').value;
            if(!n) return;
            employees.push({ id: Date.now(), name: n, role: r });
            localStorage.setItem('ep_emp', JSON.stringify(employees));
            document.getElementById('empName').value = '';
            document.getElementById('empRole').value = '';
            toggleModal('employeeModal', false);
            renderAll();
            showToast("Funcionário Adicionado");
        }

        function removeEmployee(id) {
            employees = employees.filter(e => e.id !== id);
            localStorage.setItem('ep_emp', JSON.stringify(employees));
            renderAll();
        }

        function timeToMin(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }
        function calcDiff(s, e) { let start = timeToMin(s), end = timeToMin(e); if(end < start) end += 1440; return end - start; }
        
        function switchTab(t) {
            ['escada', 'funcionarios'].forEach(s => document.getElementById(`section-${s}`).classList.toggle('hidden', s !== t));
            ['tab-escada', 'tab-funcionarios'].forEach(b => {
                const active = b === `tab-${t}`;
                document.getElementById(b).className = active ? "flex-1 py-2 px-4 rounded-xl font-bold text-xs transition-all bg-white shadow-sm text-blue-600" : "flex-1 py-2 px-4 rounded-xl font-bold text-xs transition-all text-slate-500 hover:text-slate-900";
            });
            lucide.createIcons();
        }

        function openEmployeeModal() { toggleModal('employeeModal', true); }
        function closeShiftModal() { toggleModal('shiftModal', false); }
        function toggleModal(id, s) { document.getElementById(id).classList.toggle('hidden', !s); }
        
        function showToast(m) {
            const container = document.getElementById('toastContainer');
            const t = document.createElement('div');
            t.className = "bg-slate-900 text-white px-8 py-3 rounded-full text-xs font-black shadow-2xl animate-in slide-in-from-bottom-10 duration-500 flex items-center gap-3";
            t.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i> ${m.toUpperCase()}`;
            container.appendChild(t);
            lucide.createIcons();
            setTimeout(() => {
                t.classList.add('animate-out', 'fade-out', 'slide-out-to-bottom-10');
                setTimeout(() => t.remove(), 500);
            }, 2500);
        }
    </script>
</body>
</html>

